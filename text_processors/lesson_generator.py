#!/usr/bin/env python3
import argparse
import os
import base64
import requests
import subprocess
from dotenv import load_dotenv

def encode_image(image_path):
    if not image_path or not os.path.exists(image_path):
        return None
    with open(image_path, "rb") as image_file:
        return base64.b64encode(image_file.read()).decode('utf-8')

def get_prompts(action, input_text):
    if action == "generate":
        return f"""
    –¢–´: –û–ø—ã—Ç–Ω—ã–π —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä –ø–æ –º–∞—Ç–µ–º–∞—Ç–∏–∫–µ/—Ñ–∏–∑–∏–∫–µ.
    –ó–ê–î–ê–ß–ê: –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ–∫—Å—Ç –∑–∞–∫–∞–¥—Ä–æ–≤–æ–≥–æ –≥–æ–ª–æ—Å–∞ –¥–ª—è –≤–∏–¥–µ–æ-—É—Ä–æ–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–º–µ—Ç–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    
    –í–í–û–î–ù–´–ï –î–ê–ù–ù–´–ï (–ó–∞–º–µ—Ç–∫–∏ –∏ —Ö–æ–¥ —Ä–µ—à–µ–Ω–∏—è):
    {input_text}
    
    –°–¢–†–£–ö–¢–£–†–ê –°–¶–ï–ù–ê–†–ò–Ø:
    1. –§–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã –∏ –æ—à–∏–±–∫–∏ —É—á–µ–Ω–∏–∫–∞.
    2. –†–∞–∑–±–æ—Ä —Ä–µ—à–µ–Ω–∏—è (–ø–æ—à–∞–≥–æ–≤–æ).
    3. –í—ã–≤–æ–¥—ã –∏ —á–µ–º—É –º—ã –Ω–∞—É—á–∏–ª–∏—Å—å.
    
    –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –¢–ï–ö–°–¢–£:
    - –†–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π —Å—Ç–∏–ª—å, –∫–∞–∫ –≤ —Ö–æ—Ä–æ—à–µ–º –Ω–∞—É—á-–ø–æ–ø –≤–∏–¥–µ–æ.
    - –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–π LaTeX –¥–ª—è —Ñ–æ—Ä–º—É–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä, $\\frac{{a}}{{b}}$), —ç—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏.
    - –†–∞–∑–±–µ–π —Ç–µ–∫—Å—Ç –Ω–∞ –∞–±–∑–∞—Ü—ã –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —á—Ç–µ–Ω–∏—è.
    """
    elif action == "adapt":
        return f"""
    –¢–´: –†–µ–¥–∞–∫—Ç–æ—Ä —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –¥–∏–∫—Ç–æ—Ä–∞ –∏ —Å–∏—Å—Ç–µ–º —Å–∏–Ω—Ç–µ–∑–∞ —Ä–µ—á–∏ (TTS).
    –ó–ê–î–ê–ß–ê: –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç —É—Ä–æ–∫–∞ –¥–ª—è –æ–∑–≤—É—á–∏–≤–∞–Ω–∏—è.
    
    –ò–°–•–û–î–ù–´–ô –¢–ï–ö–°–¢ –£–†–û–ö–ê:
    {input_text}
    
    –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –ê–î–ê–ü–¢–ê–¶–ò–ò:
    1. –£–±–µ—Ä–∏ –≤–µ—Å—å LaTeX. –ó–∞–º–µ–Ω–∏ —Ñ–æ—Ä–º—É–ª—ã –Ω–∞ —Ç–æ, –∫–∞–∫ –æ–Ω–∏ —á–∏—Ç–∞—é—Ç—Å—è —Å–ª–æ–≤–∞–º–∏ (—Ñ–æ–Ω–µ—Ç–∏—á–µ—Å–∫–∏).
       –ü—Ä–∏–º–µ—Ä: $\\int_0^1 x dx$ -> "–∏–Ω—Ç–µ–≥—Ä–∞–ª –æ—Ç –Ω—É–ª—è –¥–æ –µ–¥–∏–Ω–∏—Ü—ã –∏–∫—Å –¥—ç –∏–∫—Å".
    2. –ó–∞–º–µ–Ω–∏ –≤—Å–µ —Ü–∏—Ñ—Ä—ã –∏ —á–∏—Å–ª–∞ —Å–ª–æ–≤–∞–º–∏.
       –ü—Ä–∏–º–µ—Ä: "5 —è–±–ª–æ–∫" -> "–ø—è—Ç—å —è–±–ª–æ–∫", "–≤ 1990 –≥–æ–¥—É" -> "–≤ —Ç—ã—Å—è—á–∞ –¥–µ–≤—è—Ç—å—Å–æ—Ç –¥–µ–≤—è–Ω–æ—Å—Ç–æ–º –≥–æ–¥—É".
    3. –£–±–µ—Ä–∏ –ª—é–±—ã–µ markdown-—Ç–µ–≥–∏ (–∂–∏—Ä–Ω—ã–π —à—Ä–∏—Ñ—Ç, –∑–∞–≥–æ–ª–æ–≤–∫–∏), –æ—Å—Ç–∞–≤—å —Ç–æ–ª—å–∫–æ —á–∏—Å—Ç—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è —á—Ç–µ–Ω–∏—è.
    4. –°–æ—Ö—Ä–∞–Ω–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∞–±–∑–∞—Ü–µ–≤, —á—Ç–æ–±—ã –ø–∞—É–∑—ã –±—ã–ª–∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏.
    """
    elif action == "podcast":
            return f"""
    –¢–´: –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –º–æ–Ω—Ç–∞–∂–µ—Ä –∏ —Å—Ü–µ–Ω–∞—Ä–∏—Å—Ç YouTube-—Ä–æ–ª–∏–∫–æ–≤.
    –ó–ê–î–ê–ß–ê: –ü—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç –∑–∞–ø–∏—Å–∏ —ç–∫—Ä–∞–Ω–∞ c —Ç–∞–π–º—Å—Ç–∞–º–ø–∞–º–∏ –≤ —á–µ—Ç–∫–∏–π, –¥–∏–Ω–∞–º–∏—á–Ω—ã–π –∑–∞–∫–∞–¥—Ä–æ–≤—ã–π —Ç–µ–∫—Å—Ç —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –ø–∞—É–∑ –º–µ–∂–¥—É –±–ª–æ–∫–∞–º–∏ —Ç–µ–∫—Å—Ç–∞
    –≤ —Ñ–æ—Ä–º–∞—Ç–µ [[PAUSE:<–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–µ–∫—É–Ω–¥>]] —Ç–∞–∫ —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏–ª–∞—Å—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤—Ä–µ–º–µ–Ω–∏ –º–µ–∂–¥—É –∏—Å—Ö–æ–¥–Ω—ã–º –≤–∏–¥–µ–æ –∏ —Å–∏–Ω—Ç–µ–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º.

    –¢–†–ê–ù–°–ö–†–ò–ë–ê–¶–ò–Ø (–°–ª–æ–≤–∞ –∞–≤—Ç–æ—Ä–∞ –≤–æ –≤—Ä–µ–º—è –∑–∞–ø–∏—Å–∏):
    {input_text}

    –¶–ï–õ–¨:
    –°–æ–∑–¥–∞—Ç—å —Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –æ–∑–≤—É—á–µ–Ω –ø–æ–≤–µ—Ä—Ö —ç—Ç–æ–≥–æ –∂–µ –≤–∏–¥–µ–æ. –¢–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å –ø–æ —Å–º—ã—Å–ª—É —Å –ø—Ä–æ–∏—Å—Ö–æ–¥—è—â–∏–º, –Ω–æ –±—ã—Ç—å —É–º–Ω–µ–µ –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–µ–µ.

    –¢–†–ï–ë–û–í–ê–ù–ò–Ø:
    1. –°–æ—Ö—Ä–∞–Ω–∏ —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—é —Å–æ–±—ã—Ç–∏–π (—ç—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å –≤–∏–¥–µ–æ).
    2. –£–±–µ—Ä–∏ —Å–ª–æ–≤–∞-–ø–∞—Ä–∞–∑–∏—Ç—ã, –ø–∞—É–∑—ã, –º—ã—á–∞–Ω–∏–µ.
    3. –°—Ç–∏–ª—å: –î—Ä—É–∂–µ–ª—é–±–Ω—ã–π, —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π, –¥–∏–Ω–∞–º–∏—á–Ω—ã–π.
    4. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏ –º–∞—Ä–∫–¥–∞—É–Ω, —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç –¥–ª—è –æ–∑–≤—É—á–∫–∏. –†–∞–∑–±–µ–π –Ω–∞ –∞–±–∑–∞—Ü—ã –ø–æ —Å–º—ã—Å–ª–æ–≤—ã–º —Å—Ü–µ–Ω–∞–º.
    5. –í—Å—Ç–∞–≤–ª—è–π –ø–∞—É–∑—ã –º–µ–∂–¥—É –∞–±–∑–∞—Ü–∞–º–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ [[PAUSE:<–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–µ–∫—É–Ω–¥>]]
    6. –î–ª—è —Ä–∞—Å—á–µ—Ç–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø–∞—É–∑ –∏—Å–ø–æ–ª—å–∑—É–π —Å–ª–µ–¥—É—é—â—É—é —Å–∫–æ—Ä–æ—Å—Ç—å —á—Ç–µ–Ω–∏—è (12 —Å–∏–º–≤–æ–ª–æ–≤ –≤ —Å–µ–∫—É–Ω–¥—É ~ 740 —Å–∏–º–≤–æ–ª–æ–≤ –≤ –º–∏–Ω—É—Ç—É. –≠—Ç–æ –ø–æ–ª—É—á–µ–Ω–æ –∏–∑ –æ—Ü–µ–Ω–∫–∏, —á—Ç–æ 3325 —Å–∏–º–≤–æ–ª–æ–≤ —Ç–µ–∫—Å—Ç–∞ –æ–∑–≤—É—á–µ–Ω–æ –≤ 270 —Å–µ–∫—É–Ω–¥–Ω—ã–π mp3 —Ñ–∞–π–ª).
    7. –°—Ç–∞—Ä–∞–π—Å—è —É—Ä–∞–≤–Ω—è—Ç—å –¥–ª–∏–Ω—É –ø–æ–ª—É—á–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –∏ –ø–∞—É–∑ —Å –¥–ª–∏–Ω–æ–π –∏—Å—Ö–æ–¥–Ω–æ–π —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏.
    """
    return ""

def process_request(action, input_file, image_path, output_path, model, config_file):
    if config_file: load_dotenv(config_file)
    else: load_dotenv()

    # –ß–∏—Ç–∞–µ–º –≤—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª
    if not os.path.exists(input_file):
        print(f"‚ùå –û—à–∏–±–∫–∞: –í—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: {input_file}")
        exit(1)

    with open(input_file, 'r', encoding='utf-8') as f:
        input_text = f.read()

    prompt_text = get_prompts(action, input_text)

    # === –†–ï–ñ–ò–ú CUSTOM (–†–£–ß–ù–û–ô) ===
    if model == "custom":
        step_name = "–ì–ï–ù–ï–†–ê–¶–ò–Ø –°–¶–ï–ù–ê–†–ò–Ø" if action == "generate" else "–ê–î–ê–ü–¢–ê–¶–ò–Ø –î–õ–Ø TTS"
        print("\n" + "="*60)
        print(f"ü§ñ –†–ï–ñ–ò–ú CUSTOM MODEL: {step_name}")
        print("="*60)
        print(f"1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø—Ä–æ–º–ø—Ç –Ω–∏–∂–µ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–≥–æ –≤ —á–∞—Ç (ChatGPT/Claude).")
        
        if action == "generate" and image_path:
             print(f"2. üìé –ü–†–ò–ö–†–ï–ü–ò–¢–ï –ö–ê–†–¢–ò–ù–ö–£: {image_path}")
        
        print("-" * 60)
        print(prompt_text)
        print("-" * 60)
        
        # –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π —Ñ–∞–π–ª, –µ—Å–ª–∏ –Ω–µ—Ç
        if not os.path.exists(output_path):
            open(output_path, 'w').close()
            
        print(f"3. –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è Sublime Text: {output_path}")
        print("4. –í—Å—Ç–∞–≤—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤ —Ñ–∞–π–ª, —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏ –∑–∞–∫—Ä–æ–π—Ç–µ –≤–∫–ª–∞–¥–∫—É —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞.")
        
        try:
            subprocess.run(["subl", "-w", output_path], check=True)
            print(f"‚úÖ –§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω (Custom): {output_path}")
        except FileNotFoundError:
            print("‚ùå Sublime Text (subl) –Ω–µ –Ω–∞–π–¥–µ–Ω. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª –≤—Ä—É—á–Ω—É—é.")
            input("–ù–∞–∂–º–∏—Ç–µ Enter, –∫–æ–≥–¥–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ñ–∞–π–ª...")
        return

    # === –†–ï–ñ–ò–ú API ===
    api_key = os.getenv("OPENROUTER_API_KEY")
    if not api_key:
        print("‚ùå –û—à–∏–±–∫–∞: –ù–µ –∑–∞–¥–∞–Ω OPENROUTER_API_KEY")
        exit(1)

    messages = [{"role": "system", "content": "–¢—ã ‚Äî –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞."}]
    user_content = [{"type": "text", "text": prompt_text}]

    # –ö–∞—Ä—Ç–∏–Ω–∫—É –¥–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–∞ —ç—Ç–∞–ø–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    if action == "generate" and image_path:
        base64_image = encode_image(image_path)
        if base64_image:
            user_content.append({
                "type": "image_url",
                "image_url": {"url": f"data:image/jpeg;base64,{base64_image}"}
            })

    messages.append({"role": "user", "content": user_content})

    print(f"üß† –ó–∞–ø—Ä–æ—Å –∫ LLM ({model})... –î–µ–π—Å—Ç–≤–∏–µ: {action}")
    
    try:
        resp = requests.post(
            "https://openrouter.ai/api/v1/chat/completions",
            headers={
                "Authorization": f"Bearer {api_key}",
                "Content-Type": "application/json"
            },
            json={
                "model": "openai/gpt-4o" if model == "quality" else model,
                "messages": messages
            }
        )

        if resp.status_code == 200:
            content = resp.json()['choices'][0]['message']['content']
            with open(output_path, 'w', encoding='utf-8') as f:
                f.write(content)
            print(f"‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω: {output_path}")
        else:
            print(f"‚ùå –û—à–∏–±–∫–∞ API: {resp.status_code} - {resp.text}")
            exit(1)
    except Exception as e:
        print(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: {e}")
        exit(1)

if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("--action", choices=["generate", "adapt", "podcast"], required=True, help="generate: —Å–æ–∑–¥–∞–Ω–∏–µ —É—Ä–æ–∫–∞, adapt: –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–ª—è TTS")
    parser.add_argument("--input", required=True, help="–ü—É—Ç—å –∫ —Ñ–∞–π–ª—É —Å –≤–≤–æ–¥–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ (spec.txt –∏–ª–∏ lesson_script.txt)")
    parser.add_argument("--image", help="–ü—É—Ç—å –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é (—Ç–æ–ª—å–∫–æ –¥–ª—è action=generate)")
    parser.add_argument("--output", required=True, help="–ü—É—Ç—å –∫ –≤—ã—Ö–æ–¥–Ω–æ–º—É —Ñ–∞–π–ª—É")
    parser.add_argument("--model", default="custom", help="–ú–æ–¥–µ–ª—å LLM –∏–ª–∏ 'custom'")
    parser.add_argument("--config", help="–ü—É—Ç—å –∫ config.env")
    
    args = parser.parse_args()
    process_request(args.action, args.input, args.image, args.output, args.model, args.config)
