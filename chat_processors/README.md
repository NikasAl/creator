# Chat Article Processor

Генератор статей для социальных сетей на основе текстов чата с использованием LLM.

## Описание

Система для преобразования чатов с ИИ из JSON архива в статьи и видео. Скрипт анализирует файл чата в формате `### USER` / `### ASSISTANT` или извлекает чат из JSON экспорта и создает познавательную статью для публикации в социальных сетях (Pikabu, Dzen, VK). Статья генерируется с помощью LLM через OpenRouter API и может включать примеры кода, формулы, цитаты и практические советы. Затем статья может быть преобразована в видео через полный пайплайн.

## Возможности

- ✅ Парсинг JSON экспорта чатов и конвертация в текстовый формат
- ✅ Парсинг чатов в формате `### USER` / `### ASSISTANT`
- ✅ Загрузка дополнительных инструкций пользователя
- ✅ Генерация познавательных статей с примерами кода
- ✅ Поддержка разных моделей LLM (default/budget/quality)
- ✅ Автоматическое извлечение заголовка и текста
- ✅ Обработка длинных чатов (приоритет последним сообщениям)
- ✅ Интеграция с существующей конфигурацией проекта
- ✅ Интерактивная подготовка пайплайна с проверкой статусов
- ✅ Полный пайплайн от чата до видео (статья → корректура → HTML → иллюстрации → видео)

## Установка

Скрипт использует зависимости из основного проекта:

```bash
pip install -r requirements.txt
```

Убедитесь, что в `config.env` настроены API ключи:

```env
OPENROUTER_API_KEY=your_api_key_here
DEFAULT_MODEL=deepseek/deepseek-v3.2-exp
BUDGET_MODEL=google/gemini-2.5-flash-lite-preview-09-2025
QUALITY_MODEL=deepseek/deepseek-v3.2-exp
```

## Использование

### Подготовка пайплайна из JSON экспорта

Сначала подготовьте пайплайн из JSON файла с экспортом чатов:

```bash
./chat_processors/prepare_chat_pipeline.sh [json_file]
```

Скрипт:
- Парсит JSON файл с экспортом чатов
- Показывает список чатов со статусами:
  - `[NEW]` - новый чат, еще не обрабатывался
  - `[PROCESSING]` - в обработке
  - `[READY]` - готов (есть финальное видео)
  - `[PARTIAL]` - частично обработан
- Позволяет выбрать чат для обработки
- Создает директорию пайплайна `pipelines_chat/pipeline_<Название>/`
- Конвертирует чат в текстовый формат `chat.txt`
- Создает конфигурационный файл `configs/chat/<название>.conf`
- Создает маркер обработки `.processing`

### Полный пайплайн обработки чата в видео

После подготовки запустите полный пайплайн:

```bash
./process_chat.sh configs/chat/<название>.conf
```

Пайплайн включает:
1. Преобразование чата в статью
2. Корректура статьи (опционально)
3. Создание HTML версии
4. Генерация bible.json и illustrations.json
5. Генерация иллюстраций (интерактивно)
6. Генерация обложки (интерактивно)
7. Перегенерация изображений через Alibaba (опционально)
8. Генерация видеофрагментов от Alibaba (опционально)
9. Генерация финального видео (интерактивно)
10. Генерация промо-описания (интерактивно)

### Использование процессора статей напрямую

#### Базовое использование

```bash
python chat_processors/chat_article_processor.py pipeline_chat_ШрифтыВArchlinux/chat.txt
```

#### С дополнительными инструкциями

Создайте файл `instructions.txt` с вашими требованиями:

```
Сделай статью более технической, добавь больше примеров кода.
Фокус на практическом применении в Arch Linux.
Используй терминологию, понятную системным администраторам.
```

Запустите с инструкциями:

```bash
python chat_processors/chat_article_processor.py pipeline_chat_ШрифтыВArchlinux/chat.txt \
  --instructions pipeline_chat_ШрифтыВArchlinux/instructions.txt
```

#### Работа с JSON экспортом

```bash
python chat_processors/chat_article_processor.py \
  --json pipelines_chat/chat-export-*.json \
  --chat-id "88055ab3-31b0-4cd4-a9e5-f1a4114af9b9" \
  --output article.txt \
  --model quality
```

#### Выбор модели и выходного файла

```bash
python chat_processors/chat_article_processor.py pipeline_chat_ШрифтыВArchlinux/chat.txt \
  --model quality \
  --output my_article.txt \
  --instructions custom_instructions.txt
```

## Параметры командной строки

### chat_article_processor.py

- `chat_file` - Путь к файлу чата (обязательный, если не используется --json)
- `--json` - Путь к JSON файлу с экспортом чатов
- `--chat-id` - ID чата в JSON экспорте (требуется с --json)
- `-o, --output` - Путь к выходному файлу (по умолчанию: `article.txt` в той же папке)
- `--instructions` - Путь к файлу с дополнительными инструкциями
- `--config` - Путь к .env файлу с конфигурацией
- `--model` - Выбор модели: `default`, `budget`, `quality`

### prepare_chat_pipeline.sh

- `[json_file]` - Опциональный путь к JSON файлу с экспортом (если не указан, ищет первый файл в `pipelines_chat/`)

### process_chat.sh

- `config_file` - Путь к конфигурационному файлу (обязательный)

## Формат входного файла

Файл чата должен содержать сообщения в формате:

```
### USER
Вопрос пользователя или комментарий

### ASSISTANT
Ответ ассистента

### USER
Следующий вопрос

### ASSISTANT
Следующий ответ
```

## Формат выходного файла

```
Заголовок статьи
================

Текст статьи с абзацами, примерами кода, формулами и практическими советами.

Статья готова для публикации в социальных сетях без дополнительной обработки.
```

## Примеры инструкций

### Техническая статья
```
Сделай статью более технической и детальной.
Добавь больше примеров команд и кода.
Используй терминологию, понятную разработчикам.
Включи предупреждения о возможных проблемах.
```

### Популярная статья
```
Напиши статью для широкой аудитории.
Объясни сложные концепции простым языком.
Добавь аналогии и примеры из жизни.
Сделай акцент на практической пользе.
```

### SEO-оптимизированная статья
```
Добавь ключевые слова: "Linux", "шрифты", "программирование".
Структурируй статью с подзаголовками.
Включи призыв к действию в конце.
Оптимизируй для поисковых систем.
```

## Интеграция с проектом

Система интегрирована с существующей инфраструктурой проекта:

- Использует те же API ключи из `config.env`
- Поддерживает выбор моделей как в других процессорах
- Следует тем же паттернам обработки ошибок
- Совместима с существующими конфигурациями
- Использует те же процессоры для корректуры, генерации иллюстраций и видео
- Полная совместимость с пайплайном обработки поэзии (`process_poetry.sh`)

## Структура файлов

```
chat_processors/
├── chat_article_processor.py    # Процессор статей из чатов
├── chat_json_parser.py          # Парсер JSON экспорта чатов
├── prepare_chat_pipeline.sh     # Скрипт подготовки пайплайна
└── README.md                    # Документация

process_chat.sh                  # Главный скрипт обработки чата в видео

configs/
└── chat/
    └── <название>.conf          # Конфигурационные файлы (генерируются автоматически)

pipelines_chat/
├── chat-export-*.json           # JSON файлы с экспортом чатов
└── pipeline_<Название>/
    ├── .processing             # Маркер обработки
    ├── chat.txt                # Конвертированный чат
    ├── chat_metadata.json       # Метаданные чата
    ├── article.txt             # Сгенерированная статья
    └── ...                      # Остальные файлы пайплайна
```

## Ограничения

- Максимальный размер контекста: ~30,000 символов
- При превышении лимита используются последние сообщения чата
- Требуется активное подключение к интернету для работы с API
- Зависит от доступности OpenRouter API

## Устранение неполадок

### Ошибка "API ключ не найден"
Убедитесь, что в `config.env` указан `OPENROUTER_API_KEY`.

### Ошибка парсинга чата
Проверьте формат файла чата - должны быть разделители `### USER` и `### ASSISTANT`.

### Ошибка генерации статьи
Проверьте подключение к интернету и доступность OpenRouter API. Попробуйте другую модель.

### Пустая статья
Убедитесь, что в чате есть содержательные сообщения. Проверьте инструкции - они не должны противоречить задаче генерации статьи.
