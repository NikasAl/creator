#!/bin/bash

# –õ–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
log_header() {
    echo ""
    echo "======================================"
    echo "$1"
    echo "======================================"
}

# –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ —à–∞–≥–∞ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: run_step "–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–≥–∞" "—Ü–µ–ª–µ–≤–æ–π_—Ñ–∞–π–ª_–¥–ª—è_–ø—Ä–æ–≤–µ—Ä–∫–∏" –∫–æ–º–∞–Ω–¥–∞ –∞—Ä–≥—É–º–µ–Ω—Ç—ã...
# –ï—Å–ª–∏ "—Ü–µ–ª–µ–≤–æ–π_—Ñ–∞–π–ª_–¥–ª—è_–ø—Ä–æ–≤–µ—Ä–∫–∏" —Ä–∞–≤–µ–Ω "NONE", –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–∞ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è (–≤—Å–µ–≥–¥–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, –µ—Å–ª–∏ –Ω–µ RESUME_MODE)
run_step() {
    local step_name="$1"
    local target_file="$2"
    shift 2
    local command=("$@")

    log_header "$step_name"

    # –õ–æ–≥–∏–∫–∞ –ø—Ä–æ–ø—É—Å–∫–∞
    if [ "$FORCE_REDO" = "true" ]; then
        echo "üîÑ –†–µ–∂–∏–º FORCE_REDO: –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–Ω–æ–≤–æ..."
    elif [ "$RESUME_MODE" = "true" ] && [ "$target_file" != "NONE" ] && [ -f "$target_file" ]; then
        echo "‚è≠Ô∏è –ü—Ä–æ–ø—É—Å–∫: –æ–±–Ω–∞—Ä—É–∂–µ–Ω —Ñ–∞–π–ª $target_file"
        return 0
    fi

    # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã
    echo "‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫: ${command[*]}"
    "${command[@]}"
    
    local status=$?
    if [ $status -ne 0 ]; then
        echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —à–∞–≥–∞: $step_name"
        exit $status
    else
        echo "‚úÖ –®–∞–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
    fi
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
check_required_vars() {
    local missing=0
    for var in "$@"; do
        if [ -z "${!var}" ]; then
            echo "–û—à–∏–±–∫–∞: –ü–∞—Ä–∞–º–µ—Ç—Ä $var –Ω–µ –∑–∞–¥–∞–Ω."
            missing=1
        fi
    done
    if [ $missing -eq 1 ]; then
        exit 1
    fi
}