#!/usr/bin/env python3
import argparse
import subprocess
import os
import json
import shutil

def get_duration(filename):
    """–ü–æ–ª—É—á–∞–µ—Ç –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –º–µ–¥–∏–∞—Ñ–∞–π–ª–∞ —á–µ—Ä–µ–∑ ffprobe"""
    result = subprocess.run(
        ["ffprobe", "-v", "error", "-show_entries",
         "format=duration", "-of", "default=noprint_wrappers=1:nokey=1", filename],
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE
    )
    return float(result.stdout)

def main():
    parser = argparse.ArgumentParser(description="–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤–∏–¥–µ–æ –ø–æ–¥ –∞—É–¥–∏–æ")
    parser.add_argument("--video", required=True, help="–ò—Å—Ö–æ–¥–Ω–æ–µ –≤–∏–¥–µ–æ (mp4)")
    parser.add_argument("--audio", required=True, help="–ù–æ–≤–∞—è –æ–∑–≤—É—á–∫–∞ (mp3)")
    parser.add_argument("--output", required=True, help="–ò—Ç–æ–≥–æ–≤—ã–π —Ñ–∞–π–ª")
    parser.add_argument("--background-vol", default="0.1", help="–ì—Ä–æ–º–∫–æ—Å—Ç—å —Ñ–æ–Ω–∞ (–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∑–≤—É–∫–∞) 0.0-1.0")

    args = parser.parse_args()

    if not os.path.exists(args.video):
        print(f"‚ùå –í–∏–¥–µ–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ: {args.video}")
        exit(1)
    if not os.path.exists(args.audio):
        print(f"‚ùå –ê—É–¥–∏–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ: {args.audio}")
        exit(1)

    print("‚è±Ô∏è –ê–Ω–∞–ª–∏–∑ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏...")
    video_dur = get_duration(args.video)
    audio_dur = get_duration(args.audio)

    print(f"   –í–∏–¥–µ–æ: {video_dur:.2f} —Å–µ–∫")
    print(f"   –ê—É–¥–∏–æ: {audio_dur:.2f} —Å–µ–∫")

    # –í—ã—á–∏—Å–ª—è–µ–º –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —É—Å–∫–æ—Ä–µ–Ω–∏—è/–∑–∞–º–µ–¥–ª–µ–Ω–∏—è –≤–∏–¥–µ–æ (PTS)
    # –ï—Å–ª–∏ –∞—É–¥–∏–æ –∫–æ—Ä–æ—á–µ –≤–∏–¥–µ–æ -> –≤–∏–¥–µ–æ –Ω–∞–¥–æ —É—Å–∫–æ—Ä–∏—Ç—å (PTS < 1)
    # –ï—Å–ª–∏ –∞—É–¥–∏–æ –¥–ª–∏–Ω–Ω–µ–µ –≤–∏–¥–µ–æ -> –≤–∏–¥–µ–æ –Ω–∞–¥–æ –∑–∞–º–µ–¥–ª–∏—Ç—å (PTS > 1)

    # factor = audio / video.
    # new_video_dur = video_dur * (audio_dur / video_dur) = audio_dur.
    # setpts = (FACTOR) * PTS

    speed_factor = audio_dur / video_dur

    # –û–≥—Ä–∞–Ω–∏—á–∏—Ç–µ–ª–∏, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –∫–æ–º–∏—á–Ω–æ –±—ã—Å—Ç—Ä–æ –∏–ª–∏ —Å–ª–∞–π–¥-—à–æ—É
    if speed_factor < 0.5:
        print("‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –í–∏–¥–µ–æ –±—É–¥–µ—Ç —É—Å–∫–æ—Ä–µ–Ω–æ –±–æ–ª–µ–µ —á–µ–º –≤ 2 —Ä–∞–∑–∞!")
    elif speed_factor > 2.0:
        print("‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –í–∏–¥–µ–æ –±—É–¥–µ—Ç –∑–∞–º–µ–¥–ª–µ–Ω–æ –±–æ–ª–µ–µ —á–µ–º –≤ 2 —Ä–∞–∑–∞!")

    print(f"üîß –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏ –≤–∏–¥–µ–æ: {speed_factor:.3f}x (–ø–æ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)")

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ª–æ–∂–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä FFmpeg
    # [0:v] - –≤–∏–¥–µ–æ –ø–æ—Ç–æ–∫
    # [0:a] - –∑–≤—É–∫ –∏–∑ –≤–∏–¥–µ–æ (—Ñ–æ–Ω)
    # [1:a] - –Ω–æ–≤–∞—è –æ–∑–≤—É—á–∫–∞

    # 1. –í–∏–¥–µ–æ: –º–µ–Ω—è–µ–º PTS, —á—Ç–æ–±—ã –ø–æ–¥–æ–≥–Ω–∞—Ç—å –¥–ª–∏–Ω—É –ø–æ–¥ –∞—É–¥–∏–æ
    # setpts={speed_factor}*PTS

    # 2. –ó–≤—É–∫ —Ñ–æ–Ω–∞: –º–µ–Ω—è–µ–º –≥—Ä–æ–º–∫–æ—Å—Ç—å, —Ç–∞–∫–∂–µ –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –µ–≥–æ —Å–∫–æ—Ä–æ—Å—Ç—å/–¥–ª–∏–Ω—É,
    #    —á—Ç–æ–±—ã –æ–Ω —Å–æ–≤–ø–∞–¥–∞–ª —Å –≤–∏–¥–µ–æ! (atempo).
    #    –ù–æ atempo –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–∏–∞–ø–∞–∑–æ–Ω 0.5-2.0. –ï—Å–ª–∏ –±–æ–ª—å—à–µ - –Ω—É–∂–µ–Ω –∫–∞—Å–∫–∞–¥.
    #    –ü—Ä–æ—â–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å atempo –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∞ —Å –≤–∏–¥–µ–æ.

    # –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã MVP: –º—ã –æ–±—Ä–µ–∑–∞–µ–º –∏–ª–∏ –∑–∞—Ü–∏–∫–ª–∏–≤–∞–µ–º —Ñ–æ–Ω?
    # –ü—Ä–∞–≤–∏–ª—å–Ω–µ–µ: —É—Å–∫–æ—Ä–∏—Ç—å —Ñ–æ–Ω —Ç–∞–∫ –∂–µ, –∫–∞–∫ –≤–∏–¥–µ–æ.

    # atempo filter –±–µ—Ä–µ—Ç –æ–±—Ä–∞—Ç–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç: –µ—Å–ª–∏ –≤–∏–¥–µ–æ —É—Å–∫–æ—Ä—è–µ–º (0.5 –¥–ª–∏–Ω—ã), —Ç–µ–º–ø –∑–≤—É–∫–∞ 2.0.
    tempo = 1 / speed_factor

    audio_filter = f"volume={args.background_vol},atempo={tempo}"

    # –ó–∞—â–∏—Ç–∞ –æ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π atempo (0.5 - 2.0)
    # –ï—Å–ª–∏ –≤—ã—Ö–æ–¥–∏–º –∑–∞ —Ä–∞–º–∫–∏, –ø—Ä–æ—Å—Ç–æ –æ–±—Ä–µ–∑–∞–µ–º/–ø–∞–¥–¥–∏–º —Ñ–æ–Ω –±–µ–∑ –ø–∏—Ç—á-—à–∏—Ñ—Ç–∞ (—Å–ª–∏—à–∫–æ–º —Å–ª–æ–∂–Ω–æ –¥–ª—è –±–∞—à–∞)
    # –í —ç—Ç–æ–º —Å–∫—Ä–∏–ø—Ç–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º simple fit: –≤–∏–¥–µ–æ —Ä–µ—Å–∞–π–∑–∏–º, –∞—É–¥–∏–æ —Ñ–æ–Ω–∞ –±–µ—Ä–µ–º –∫–∞–∫ –µ—Å—Ç—å (–æ–±—Ä–µ–∑–∞–µ–º –∏–ª–∏ —Ñ–µ–π–¥–∏–º)

    print("üé¨ –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞...")

    # –ö–æ–º–∞–Ω–¥–∞ FFmpeg
    # -filter_complex:
    # [0:v]setpts=FACTOR*PTS[v];  <- –°–∫–µ–π–ª–∏–º –≤–∏–¥–µ–æ
    # [0:a]volume=0.1[bg];        <- –¢–∏—Ö–∏–π —Ñ–æ–Ω (–±–µ–∑ —Ä–µ—Ç–∞–π–º–∏–Ω–≥–∞, –ø—Ä–æ—Å—Ç–æ –æ—Ä–∏–≥–∏–Ω–∞–ª)
    # [1:a]volume=1.0[fg];        <- –ì–æ–ª–æ—Å
    # [bg][fg]amix=inputs=2:duration=shortest[a] <- –ú–∏–∫—Å

    # –ù–Æ–ê–ù–°: –ï—Å–ª–∏ –º—ã —É—Å–∫–æ—Ä–∏–ª–∏ –≤–∏–¥–µ–æ, –∞ —Ñ–æ–Ω –æ—Å—Ç–∞–≤–∏–ª–∏ –∫–∞–∫ –µ—Å—Ç—å, –æ–Ω–∏ —Ä–∞–∑—ä–µ–¥—É—Ç—Å—è.
    # –õ–£–ß–®–ï–ï –†–ï–®–ï–ù–ò–ï –î–õ–Ø –ü–û–î–ö–ê–°–¢–ê: –£–±–∏—Ç—å –∑–≤—É–∫ –∏–≥—Ä—ã –∏–ª–∏ —Å–¥–µ–ª–∞—Ç—å –µ–≥–æ –æ—á–µ–Ω—å —Ç–∏—Ö–∏–º –∏ –ø—Ä–æ—Å—Ç–æ –æ–±—Ä–µ–∑–∞—Ç—å –ø–æ –∫–æ–Ω—Ü—É.

    cmd = [
        "ffmpeg", "-y",
        "-i", args.video,
        "-i", args.audio,
        "-filter_complex",
        f"[0:v]setpts={speed_factor}*PTS[v];[0:a]volume={args.background_vol}[bg];[1:a]volume=1.0[fg];[bg][fg]amix=inputs=2:duration=shortest[a_out]",
        "-map", "[v]", "-map", "[a_out]",
        "-c:v", "libx264", "-preset", "medium", "-crf", "23",
        "-c:a", "aac", "-b:a", "192k",
        args.output
    ]

    try:
        subprocess.run(cmd, check=True)
        print(f"‚úÖ –ì–æ—Ç–æ–≤–æ! –§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω: {args.output}")
    except subprocess.CalledProcessError as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ FFmpeg: {e}")

if __name__ == "__main__":
    main()